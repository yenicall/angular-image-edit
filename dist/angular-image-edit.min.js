/*! angular-image-edit - version 0.1.1 - 08-03-2015
 * An angular directive to crop and resize images
 * Copyright (c) 2015 Pedro Mangabeira <pedro@easy-guild.net> 
 * Licensed under the MIT
*/
!function(){angular.module("ImageEdit",["ngTouch","superswipe"]).directive("imageEdit",["$rootScope","$q","$swipe","canvasToBlob",function(a,b,c,d){return{template:'<div id="image-crop-{{ rand }}" class="ng-image-edit" ng-style="moduleStyles" ng-show="imageLoaded"><section ng-style="sectionStyles" class="wrapper"><canvas class="canvas"  width="{{ canvasWidth }}" height="{{ canvasHeight }}"></canvas></section></div>',replace:!0,restrict:"AE",link:function(e,f,g){var h,i,j,k,l,m,n,o=f[0],p=o.getElementsByClassName("canvas")[0],q=p.getContext("2d"),r=new Image,s=.7,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A={x:0,y:0};e.imageLoaded=!1,e.rand=Math.round(99999*Math.random()),e.width=parseInt(g.width,10)||300,e.height=parseInt(g.height,10)||300,e.canvasWidth=e.width,e.canvasHeight=e.height,e.moduleStyles={width:e.width+"px",height:e.height+"px"},e.sectionStyles={width:e.width+"px",height:e.height+"px"},e.croppingGuideStyles={width:e.width+"px",height:e.height+"px",top:0,left:0},g.type||(g.type="png"),e.$watch(g.src,function(a){a&&(r.src=a)}),e.$watch(g.zoom,function(a){a=parseFloat(a),isNaN(a)||(a>100&&(a=100),l(a))}),k=function(){var a;return a=b.defer(),d(p,function(b){return a.resolve(b)},"image/"+e.type),a.promise},m=function(){i=r.width*t,j=r.height*t,i<p.width?(w=0,x=p.width-i):(w=p.width-i,x=0),j<p.height?(y=0,z=p.height-j):(y=p.height-j,z=0)},l=function(a){a/=100,t=a*s+(1-a)*h,m(),w>u?u=w:u>x&&(u=x),y>v?v=y:v>z&&(v=z),q.clearRect(0,0,p.width,p.height),q.drawImage(r,v,v,i,j)},n=function(a,b){a=u+a,(w>a||a>x)&&(a=u),u=a,b=v+b,(y>b||b>z)&&(b=v),v=b,q.clearRect(0,0,p.width,p.height),q.drawImage(r,a,b,i,j)},r.error=function(){e.imageLoaded=!1,a.$broadcast("ImageEdit:loadFail")},r.onload=function(){e.$apply(function(){e.imageLoaded=!0;var b=r.width,c=r.height;u=0,v=0,h=function(){return p.width>p.height?p.height/c:p.width/b}();var d=parseFloat(g.zoom);isNaN(d)&&(d=0),l(d),a.$broadcast("ImageEdit:loaded",b,c)})},c.bind(angular.element(p),{start:function(a){A.x=a.x,A.y=a.y},move:function(a){var b=(a.x-A.x)*h,c=(a.y-A.y)*h;n(b,c)},end:function(a){var b=(a.x-A.x)*h,c=(a.y-A.y)*h;n(b,c)}}),e.$on("ImageEdit:edit",function(b){b&&b.preventDefault(),k().then(function(b){a.$broadcast("ImageEdit:done",{blob:b,uri:p.toDataURL()})})})}}}]).service("canvasToBlob",function(){var a,b,c;return c=/\s*;\s*base64\s*(?:;|$)/i,a=void 0,b=function(b){var c,d,e,f,g,h,i,j,k,l;for(g=b.length,c=new Uint8Array(g/4*3|0),e=0,h=0,f=[0,0],k=0,j=0,i=void 0,d=void 0,l=void 0;g--;)d=b.charCodeAt(e++),i=a[d-43],255!==i&&i!==l&&(f[1]=f[0],f[0]=d,j=j<<6|i,k++,4===k&&(c[h++]=j>>>16,61!==f[1]&&(c[h++]=j>>>8),61!==f[0]&&(c[h++]=j),k=0));return c},a=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]),function(a,d,e){var f,g,h,i,j,k;return e||(e="image/png"),a.mozGetAsFile?void d(a.mozGetAsFile("canvas",e)):(f=Array.prototype.slice.call(arguments,1),i=a.toDataURL(e),j=i.indexOf(","),h=i.substring(j+1),k=c.test(i.substring(0,j)),g=void 0,Blob.fake?(g=new Blob,g.encoding=k?"base64":"URI",g.data=h,g.size=h.length):Uint8Array&&(g=k?new Blob([b(h)],{type:e}):new Blob([decodeURIComponent(h)],{type:e})),d(g))}})}();